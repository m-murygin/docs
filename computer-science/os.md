# Операционная система

## Роли
1. ОС выполнеяет следующие роли:
    * Memory management
    * Scheduling - планирование (выполнение нескольких программа параллельно)
    * IPC (межпроцессорное взаимодействие)

## Прерывания
1. **Прерывание** - событие, которое заставляет процессор прервать текущую задачу и вызвать специальный обработчик
1. Виды:
    * внешнее устройство требует внимания - сетевая карта заполнила свой буффер и сигнализирует процессору чтобы он забрал данные, дабы избежать потерь
    * произошла ошибка при выполнение инструкции
    * специальная инструкция (syscall)
1. Прерывания могут происходить асинхронно
    * код не готов к тому, что его прервут
    * т.е. обработчик прерывания ответственнен за сохранение состояния прерванной задачи
1. Обработчики прерывания это часть ядра операционной системы.
    * ОС сообщает процессору где лежит таблица обработчиков прерываний и каким событиям какой обработчик соответствует
1. Вызов обработчика прерывания
    * процессор сохраняет состояние текущего исполняемого кода (стэк, флаги, RIP)
    * процессор не сохраняет регистры специального назначения, поэтому если обработчик планирует такие регистры использовать, то нужно обязательно сохранять исходное значение, и вернуть его после завершения.
    * выполняет логику обработчика прерывания
    * восстанавливает регистры специального назначение
    * вызвает `iretq` (команда процессору вернуть состояние кода, который выполнялся до прерывания)

## Виды памяти
1. Автоматическая - стэк
1. Статическая - встраивается в приложение. Секции `.bss` и `.data` в ассемблере.
1. Динамическая - куча

## Выделение памяти
1. При выделение памяти в начале участка (или в некоторых ситуациях перед началом участка памяти) сохраняется структура MCB (memory control block). Т.е. указатель на следующий блок выделенной памяти.
    ```c
    struct MCB {
        size_t offset;
        size_t size;
        MCB * next;
    };
    ```
1. ОС при загрузке проставляет корневой MCB, при каждом последующем выделении она добавляет новый MCB в цепочку.
1. Для того чтобы понять не занят ли участок нужно пробежаться по всем `MCB`
1. Для очистки участка памяти достаточно просто переставить указатель `MCB * next`

## Планировщик
1. В железе существует таймер, который генерирует прерывание каждый такт времени.
1. В обработчик прерывания таймера мы можем вставить свой пользовательский код, к примеру считать координаты мышки и передвинуть курсор.
1. Планировщик выполняется по прерыванию таймера и делает следующее:
    * Снимает процесс с выполнения (копирует все его регистры)
    * Выбирает следующий процесс на выполнение, выбирает какой поток нужно поставить на выполнение
    * Ставит процесс на выполнение (копирует регистры процесса в процессор)
1. Процесс владеет следующими ресурсами
    1. Адрессное пространство (память)
    1. Потоки
    1. Системные объекты (открытые файлы, семафоры)
1. Поток - это цепочка команд выполняемая в памяти процессора

