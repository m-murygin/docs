# Компиляция

## Table of Content
- [Стадии компиляции](#%D1%81%D1%82%D0%B0%D0%B4%D0%B8%D0%B8-%D0%BA%D0%BE%D0%BC%D0%BF%D0%B8%D0%BB%D1%8F%D1%86%D0%B8%D0%B8)
- [g++](#g)

## Стадии компиляции
1. **Препроцессор**
    * Язык препроцессора - это специальный язык программирования, встроенный с С++ю
    * Препроцессор работает с кодом на С++ как с текстом.
    * Команды языка препроцессор называют директивами, все директивы начинаются со знака #.
    * Директива `#include` позволяет подключать заголовочные файлы к файлам кода.
        * `#include <foo.h>` - библиотечный заголовочный файл
        * `#include "foo.h"` - локальный заголовочный файл
    * Препроцессор заменяет директиву `#include "bar.h"` на содержимое файла _bar.h_.
2. **Компиляция**
    * На вход компилятору поступает код на С++ после обработки препроцессором.
    * Каждый файл с кодом компилируется отдельно и независимо от других файлов с кодом.
    * Компилируются только файлы с кодом (т.е. *.срр).
    * Заголовочные файлы сами по себе ни во что не компилируются, только в составе файлов с кодом.
    * На выходе компилятора из каждого файла с кодом получается **объектный файл** - бинарный файл со скомпилированным кодом (с расширением `.o` или `.obj`)
3. **Линтовка (компоновка)**
    * На этом этапе все объектные файлы объединияются в один исполняемый (или библиотечный) файлю
    * При этом происходит подстановка адресов функций в места их вызова.
        ```cpp
        void foo()
        {
            bar(); // call <address of bar>, e.g. call 0x087A
        }
        void bar() { }
        ```
    * По каждому объектному файлу строится таблица функций, которые в нём определены.
    * На этапе компоновки важно, что каждая функция имеет уникальное имя.
    * В С++ может быть две функции с одним именем, но разными параметрами. Для того чтобы функции имели уникальные имена они искажаются (mangle) таким образом, что в их имени кодируются их параметры. Например, комплятора GCC превратит имя функции `foo`
        ```cpp
        void foo(int, double) {} // _Z3foooid
        ```
    * Аналогично в линтовке нуждаются глобальные переменные.
    * Точка входа - функция, вызываемая при запуске программы. По умолчанию это функция `main`.
        ```cpp
        int main()
        {
            return 0;
        }
        ```
        или
        ```cpp
        int main(int argc, char ** argv)
        {
            return 0;
        }
        ```
    * Ошибки линковки:
        * `undefined reference` - функции имеет объявление, но не имеет тела
        * `multiple definition` - функция имеет два или более определений (часто возникает в ситуации когда функция определена в заголовочном файле, который включен в несколько .cpp файлов)

## g++
1. **g++** - обёртка над набором программ (препроцессор, компилятор и линтовщик). Запускает нужную утилиту или последовательность утилит в зависимости от входных параметров.
1. Запустить препроцессор на файле:
    ```bash
    g++ -E main.cpp -o main_preprocessed.cpp
    ```
1. Запуск компилятора (на выходе получаем объектный файл с расширением `.o`)
    ```bash
    g++ -с main.cpp
    ```
1. Компоновка
    ```bash
    g++ file1.o main.o -o programm
    ```
1. Для того чтобы запустить препроцессор, компилятор и компоновщик одной командой
    ```bash
    g++ file1.cpp main.cpp -o programm
    ```
1. Чтобы посмотреть содержание объектного файла в виде ассемблера
    ```bash
    g++ -S main.cpp
    ```
