# Запросы

## Table of content
- [Жизненный цикл запроса](#жизненный-цикл-запроса)
- [HDD](#hdd)
- [Оконные функции](#оконные-функции)

## Жизненный цикл запроса
1. Приложение устанавливает соединение с БД
1. Приложение посылает текст запроса серверу БД
1. Сервер проверяет синтаксическую корректность запроса
1. Сервер проверяет существуют ли запрошенные таблицы\колонки + проверяет имеет ли текущий пользователь доступ к этим данным
1. Сервер составляет план запроса
1. Сервер выполняет запрос
1. Сервер отсылает данные приложению.

## HDD

* ![HDD](../images/hdd.png)

1. На крутящейся поверхности винчестера находятся концентрические окружности - **дорожки**.
1. Каждая дорожка разделена на некоторое количество дуг - **секторов**.
1. К поверхности диска преставлено коромысло, к которому преставлены считывающие магнитные головки.
1. Для того чтобы прочитать данные с диска головке нужно переместится на необходимую дорожку и дождаться когда до неё докрутится необходимый сектор.
1. Сектор является единицей чтения информации, чтобы прочитать с сектора 1 байт нужно прочитать весь сектор целиком.
1. Размер сектора варьируется в диапазоне от `[512b - few kb]`
1. База данных хранит данные на нескольких секторах подряд. Такой набор секторов называется страницей.
    * Для `mysql` по умолчанию размер страницы `16kb` (можно настроить 64, 32, 8)
    * `postgresql` размер страницы - `8kb`

## Оконные функции
1. Разбивает выборку на партиции (аналогично группировке строк)
1. Сортирует каждую партицию по какому-то признаку
1. `SELECT` кроме использования текущей строки может так же оперировать с окном, состоящим из строк той же партиции
1. Если партиция не упорядочнена, то значение агрегата считается по всем строкам попавшим в одно окно с текущей строкой. Если партиция упорядочнена, то значение агрегата считается от начала окна до текущей строки включительно.

    * отношение числа статей на конференции к среднему числу статей на данной конференции по всем годам

        ```sql
        SELECT year, name,
            paper_count / AVG (paper_count) OVER (
                PARTITION BY name
            )
        FROM SubmittedPapersPerEvent;
        ```

    * Рост суммы количества статей на конференции по годам

        ```sql
        SELECT year, name,
            paper_count / AVG (paper_count) OVER (
                PARTITION BY name ORDER BY year ASC
            )
        FROM SubmittedPapersPerEvent;
        ```

1. Можно самостоятельно указать размер окна

    * Отношение количества статей на текущей конференции к количеству статей на прошлой.

        ```sql
        SELECT year, name,
            paper_count::FLOAT / FIRST_VALUE(paper_count) OVER (
                PARTITION BY name ORDER BY year ASC
                ROWS BETWEEN 1 PRECEDING AND CURRENT ROW
            ) as yoy_growth
        FROM SubmittedPapersPerEvent;
        ```
